# Deep TMS Coil Placement Optimization via Biophysical Simulation

This repository contains simulation and analysis code for a research project investigating whether **deep transcranial magnetic stimulation (TMS)** coils can effectively target **deep brain structures**, and where on the scalp such coils should be placed to maximize stimulation of those targets.

The project combines large-scale **biophysical simulations**, **coordinate transformations**, and **unsupervised learning methods** to identify consistent optimal coil placement locations across subjects.

---

## Background

Transcranial Magnetic Stimulation (TMS) is a non-invasive neurostimulation technique that modulates neural activity using magnetic fields generated by an external coil placed on the scalp. While conventional TMS is effective for superficial cortical regions, its ability to stimulate **deep brain structures** remains an open research question.

In contrast, **Deep Brain Stimulation (DBS)** is highly effective at targeting deep structures but is invasive, expensive, and associated with surgical risks. Deep TMS coils (e.g., the H1 coil) have been developed to reduce magnetic field dissipation with depth, but their effectiveness for targeting subcortical regions has not been well validated.

This work aims to computationally evaluate deep TMS as a potential non-invasive alternative to DBS.

---

## Research Objectives

The goals of this project are to:

- Determine whether deep TMS coils can meaningfully stimulate deep brain structures
- Identify optimal scalp locations for coil placement
- Evaluate whether optimal locations are consistent across individuals
- Validate optimal locations through secondary finite-element simulations

---

## Target Brain Structures

Simulations were performed for the following structures, which are commonly targeted in DBS:

- Amygdala
- Anterior Cingulate Cortex
- Fornix
- Globus Pallidus
- Hippocampus
- Periaqueductal Gray
- Subthalamic Nucleus
- Ventromedial Thalamic Nucleus

Each structure is handled by a dedicated optimization script.

---

## Repository Structure

### Simulation Scripts (Optimal Coil Placement)

The following scripts run SimNIBS optimization routines to find the optimal scalp coordinates for stimulating each target structure:

- `find_optimal_coords_for_Amygdala.py`
- `find_optimal_coords_for_AntCingCortex.py`
- `find_optimal_coords_for_Fornix.py`
- `find_optimal_coords_for_GlobusPal.py`
- `find_optimal_coords_for_Hippocampus.py`
- `find_optimal_coords_for_PeriaqueductalGray.py`
- `find_optimal_coords_for_Subthalamic.py`
- `find_optimal_coords_for_VentromedialNucleus.py`

Each script:
- Takes subject-specific head meshes as input
- Converts target coordinates from MNI space to subject space
- Iteratively simulates coil placements across the scalp
- Outputs the optimal coil placement for each subject

---

### Coordinate Transformation Utilities

- `interpret_affine_coordinates.py`  
  Converts coordinates between subject MRI space and MNI space using affine transformations. This enables aggregation and comparison of results across subjects.

---

### Analysis and Visualization Scripts

These scripts analyze and visualize the optimal coil coordinates obtained from the simulations:

- `kmeans_clustering.py`  
  Applies K-means clustering to identify representative optimal coil locations.

- `agglomerative_clustering.py`  
  Performs hierarchical clustering to detect stable clusters and identify cases with multiple optimal sites.

- `TSNE_visualization.py`  
  Uses t-SNE dimensionality reduction to visualize spatial trends and cluster structure in two dimensions.

---

### Secondary Finite-Element Validation

These scripts re-run finite-element simulations using cluster-derived optimal coordinates to quantify electric field intensity at the target structures:

- `FEA_simulations_with_optimal_coords1.py`
- `FEA_simulations_with_optimal_coords2.py`
- `FEA_simulations_with_optimal_coords3.py`

These simulations serve as a validation step for the clustering results.

---

### Data and Example Outputs

- `2_Guys/`  
  Contains raw input data, including T1- and T2-weighted MRI files and SimNIBS head reconstructions (`.msh`) used as input to the optimization scripts.

- `subthalamicIXI2_Guys/`  
  Contains example output from a full optimization run targeting the subthalamic nucleus, including `.msh`, `.opt`, `.geo`, `.log`, `.mat`, and target files produced by SimNIBS.

- `IXI2_TMS_optimize_No9_H1_nii.msh`  
  A representative finite-element mesh with electric field intensity mapped onto brain tissue. This file illustrates how stimulation strength varies spatially and can be visualized in Gmsh or SimNIBS.

---

## Software and Dependencies

- SimNIBS
- SPM12 / CAT12 (used during head reconstruction)
- Python scientific stack:
  - NumPy
  - SciPy
  - scikit-learn
  - pandas
  - matplotlib

Large data files are managed using **Git LFS**.

---

## Disclaimer

This repository contains **computational simulations only**.  
It is intended for **research and educational purposes** and does **not constitute medical advice**.  
No clinical claims are made regarding treatment efficacy.

---

## Summary

This repository provides a complete simulation-to-analysis pipeline for optimizing deep TMS coil placement, identifying consistent stimulation sites across individuals, and validating these sites using finite-element modeling. The work contributes to ongoing research on non-invasive alternatives to deep brain stimulation and demonstrates how computational modeling can guide neurotechnology development.
